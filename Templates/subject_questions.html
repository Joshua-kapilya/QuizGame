{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h3>{{ subject.name }} - Tournament Questions</h3>

    <!-- üïí TIMER SECTION -->
    <div class="alert alert-info text-center fs-5" id="timer-section">
        ‚è±Ô∏è Time Remaining: <span id="timer">--:--</span>
    </div>

    <form id="quiz-form">
        {% for question in questions %}
        <div class="question-block" 
             id="question-{{ forloop.counter }}" 
             data-question-id="{{ question.id }}" 
             style="display: {% if forloop.first %}block{% else %}none{% endif %};">

            <p><strong>Question {{ question.question_number }}:</strong></p>

            {% if question.question_type == "text" %}
                <p>{{ question.text|safe }}</p>
            {% elif question.question_type == "image" %}
                <img src="{{ question.diagram.url }}" alt="Diagram" class="img-fluid mb-2">
            {% endif %}

            <div>
                <label><input type="radio" name="answer_{{ question.id }}" value="A"> {{ question.option_a }}</label><br>
                <label><input type="radio" name="answer_{{ question.id }}" value="B"> {{ question.option_b }}</label><br>
                <label><input type="radio" name="answer_{{ question.id }}" value="C"> {{ question.option_c }}</label><br>
                <label><input type="radio" name="answer_{{ question.id }}" value="D"> {{ question.option_d }}</label>
            </div>
        </div>
        {% endfor %}

        <div class="mt-3 text-center">
            <button type="button" id="prev-btn" class="btn btn-secondary" disabled>Previous</button>
            <button type="button" id="next-btn" class="btn btn-primary">Next</button>
        </div>
    </form>
</div>

<script>
    let currentQuestion = 1;
    const totalQuestions = {{ questions|length }};
    
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");

    // üïí TIMER SETUP
    let timeLeft = {{ subject.time_limit }}; // Time limit from DB (in seconds)
    const timerDisplay = document.getElementById("timer");

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
    }

    function updateTimer() {
        timeLeft--;
        timerDisplay.textContent = formatTime(timeLeft);

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert("‚è∞ Time is up! Submitting your quiz...");
            submitQuiz();
        }
    }

    timerDisplay.textContent = formatTime(timeLeft);
    const timerInterval = setInterval(updateTimer, 1000);

    // ‚úÖ QUIZ NAVIGATION
    function showQuestion(index) {
        document.querySelectorAll(".question-block").forEach((q, i) => {
            q.style.display = (i + 1 === index) ? "block" : "none";
        });
        prevBtn.disabled = index === 1;
        nextBtn.textContent = index === totalQuestions ? "Submit" : "Next";
    }

    function isAnswered(index) {
        const radios = document.querySelectorAll(`#question-${index} input[type="radio"]`);
        return Array.from(radios).some(r => r.checked);
    }

    // ‚úÖ QUIZ SUBMISSION FUNCTION
    function submitQuiz() {
        clearInterval(timerInterval); // stop timer if still running

        const answers = [];
        document.querySelectorAll(".question-block").forEach(block => {
            const qid = block.dataset.questionId;
            const selected = block.querySelector("input[type=radio]:checked");
            if (selected) {
                answers.push({
                    question_id: qid,
                    answer_value: selected.value
                });
            }
        });

        fetch("{% url 'submit_tournament_quiz' subject.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ answers: answers })
        })
        .then(response => response.text())
        .then(html => {
            document.open();
            document.write(html);
            document.close();
        });
    }

    // ‚úÖ Button Logic
    prevBtn.addEventListener("click", () => {
        if (currentQuestion > 1) {
            currentQuestion--;
            showQuestion(currentQuestion);
        }
    });

    nextBtn.addEventListener("click", () => {
        if (!isAnswered(currentQuestion)) {
            alert("Please answer this question before proceeding.");
            return;
        }

        if (currentQuestion < totalQuestions) {
            currentQuestion++;
            showQuestion(currentQuestion);
        } else {
            submitQuiz();
        }
    });

    showQuestion(currentQuestion);
</script>

{% endblock %}
